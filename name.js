// 66 @key @奶茶姐 update 2023.4.28 -5 压缩优化速度 可能？ 测试未压缩版在name_dev 说明： https://github.com/Keywos/rule
const $=$substore;const{isLoon:isLoon,isSurge:isSurge,isQX:isQX}=$substore.env;const target=isLoon?"Loon":isSurge?"Surge":isQX?"QX":undefined;const timeout=$arguments["timeout"]?$arguments["timeout"]:1e3;const flag=$arguments["flag"];const batch_size=$arguments["batch"]?$arguments["batch"]:16;async function operator(e){const t=isLoon||isSurge;if(!t){$.error(`Only supports Loon and Surge!`);return e}const o=new Date;const n=e.length;let s=0;while(s<e.length){const t=e.slice(s,s+batch_size);await Promise.allSettled(t.map((async e=>{try{const t=await queryDNSInfo(e.server);const o=await queryIpApi(e);e.name=flag?getFlagEmoji(o.countryCode)+" "+(t===o.query?"直连":"中转")+"→"+o.country:o.country;e.qc=t+"|"+o.query}catch(e){console.log(`err = ${e}`)}})));s+=batch_size}e=removeDuplicateName(e);const c=processProxies(e);e=removeqcName(e);console.log(`初始节点数 = `+n);console.log(`去重后个数 = ${e.length}`);const r=new Date;const a=r.getTime()-o.getTime();console.log(`方法总耗时 = ${a/1e3} 秒`);return e}async function queryDNSInfo(e){const t=/^\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}$/.test(e);if(t){console.log("此节点入口为IP不查DNS");return e}return new Promise(((t,o)=>{const n=`http://223.5.5.5/resolve?name=${e}&type=A&short=1`;$.http.get({url:n}).then((e=>{const o=JSON.parse(e.body);if(o.length>0){t(o[0])}})).catch((e=>{console.log("dns = "+e);o(e)}))}))}async function queryIpApi(e){return new Promise(((t,o)=>{const n=`http://ip-api.com/json?lang=zh-CN&fields=status,message,country,countryCode,city,query`;let s=ProxyUtils.produce([e],target);const c=new Promise(((e,t)=>{setTimeout((()=>{t(new Error("请求超时,丢弃节点"))}),timeout)}));const r=$.http.get({url:n,node:s,"policy-descriptor":s}).then((e=>{const n=JSON.parse(e.body);if(n.status==="success"){t(n)}else{o(new Error(n.message))}})).catch((e=>{console.log("api = "+e);o(e)}));Promise.race([c,r]).catch((e=>{o(e)}))}))}function removeDuplicateName(e){const t=new Set;const o=[];for(const n of e){if(n.qc&&!t.has(n.qc)){t.add(n.qc);o.push(n)}}return o}function removeqcName(e){const t=new Set;const o=[];for(const n of e){if(!t.has(n.qc)){t.add(n.qc);const e={...n};delete e.qc;o.push(e)}}return o}function processProxies(e){const t=e.reduce(((e,t)=>{const o=e.find((e=>e.name===t.name));if(o){o.count++;o.items.push({...t,name:`${t.name} ${o.count.toString().padStart(2,"0")}`})}else{e.push({name:t.name,count:1,items:[{...t,name:`${t.name} 01`}]})}return e}),[]);const o=t.flatMap((e=>e.items));e.splice(0,e.length,...o);return e}function getFlagEmoji(e){const t=e.toUpperCase().split("").map((e=>127397+e.charCodeAt()));return String.fromCodePoint(...t).replace(/🇹🇼/g,"🇨🇳")}