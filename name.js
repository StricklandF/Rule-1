// @key @奶茶姐 update 2023.4.28 -1 压缩优化速度 可能？ 测试未压缩版在name_dev 说明： https://github.com/Keywos/rule
const $=$substore;const{isLoon:isLoon,isSurge:isSurge,isQX:isQX}=$substore.env;const target=isLoon?"Loon":isSurge?"Surge":isQX?"QX":undefined;const timeout=$arguments["timeout"]?$arguments["timeout"]:800;const flag=$arguments["flag"];const batch_size=$arguments["batch"]?$arguments["batch"]:20;async function operator(t){const e=new Date;console.log("初始节点数 = "+t.length);let o=0;while(o<t.length){const e=t.slice(o,o+batch_size);await Promise.allSettled(e.map((async t=>{try{const e=await queryDNSInfo(t.server);const o=await queryIpApi(t);t.name=flag?getFlagEmoji(o.countryCode)+" "+(e===o.query?"直连":"中转")+"→"+o.country:o.country;t.qc=e+"|"+o.query}catch(t){console.log(`err = ${t}`)}})));o+=batch_size}t=re(t);console.log(`去重后个数 = ${t.length}`);const n=new Date;const s=n.getTime()-e.getTime();console.log(`方法总耗时 = ${s/1e3} 秒`);return t}async function queryDNSInfo(t){return new Promise(((e,o)=>{const n=t;const s=`http://223.5.5.5/resolve?name=${t}&type=A&short=1`;$.http.get({url:s}).then((t=>{const o=JSON.parse(t.body);if(o.length>0){e(o[0])}else{e(n)}})).catch((t=>{console.log("dns = "+t);o(t)}))}))}async function queryIpApi(t){return new Promise(((e,o)=>{const n=`http://ip-api.com/json?lang=zh-CN&fields=status,message,country,countryCode,city,query`;let s=ProxyUtils.produce([t],target);if(isLoon){s=s.substring(s.indexOf("=")+1)}const r={policy:s.substring(s.lastIndexOf("=")+1)};const c=new Promise(((t,e)=>{setTimeout((()=>{e(new Error("请求超时,丢弃节点"))}),timeout)}));const i=$.http.get({url:n,opts:r,node:s,"policy-descriptor":s}).then((t=>{const n=JSON.parse(t.body);if(n.status==="success"){e(n)}else{o(new Error(n.message))}})).catch((t=>{console.log("api = "+t);o(t)}));Promise.race([c,i]).catch((t=>{o(t)}))}))}function re(t){const e=new Set;const o=[];for(const n of t){if(n.qc&&!e.has(n.qc)){e.add(n.qc);o.push(n)}}const n=o.reduce(((t,e)=>{const o=e.px;if(!t[o]){t[o]=[]}t[o].push(e);return t}),{});for(const t in n){if(n.hasOwnProperty(t)){const e=n[t];e.forEach(((t,e)=>{t.name=`${t.name}${" "}${e<10?"0":""}${e+1}`}))}}return Object.values(n).flat()}function getFlagEmoji(t){const e=t.toUpperCase().split("").map((t=>127397+t.charCodeAt()));return String.fromCodePoint(...e).replace(/🇹🇼/g,"🇨🇳")}